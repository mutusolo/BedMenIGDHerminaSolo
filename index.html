<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard TT dan LOS IGD Hermina Solo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            margin: 0;
            padding: 0;
        }

        .container {
            width: 100%;
            height: 100vh;
            padding: 10px;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 10px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .header-left h1 {
            font-size: 2.2em;
            color: #2d3436;
            margin-bottom: 5px;
        }

        .datetime {
            color: #636e72;
            font-size: 1.1em;
            font-weight: 500;
        }

        .settings-btn {
            background: #74b9ff;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(116, 185, 255, 0.3);
            transition: all 0.3s ease;
        }

        .settings-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(116, 185, 255, 0.4);
        }

        .navigation {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 10px;
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .nav-btn {
            flex: 1;
            padding: 12px 20px;
            background: transparent;
            border: 2px solid #ddd;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        .nav-btn.active {
            background: #74b9ff;
            color: white;
            border-color: #74b9ff;
        }

        .nav-btn:hover:not(.active) {
            border-color: #74b9ff;
            color: #74b9ff;
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            flex: 1;
            overflow-y: auto;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .bed-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid #ddd;
            transition: all 0.3s ease;
        }

        .bed-card.level1,
        .bed-card.level2 {
            border-left-color: #e74c3c;
            background: #ffebee;
        }

        .bed-card.level3 {
            border-left-color: #f39c12;
            background: #fff8e1;
        }

        .bed-card.level4,
        .bed-card.level5 {
            border-left-color: #27ae60;
            background: #f0fff4;
        }

        .bed-card.no-triase {
            border-left-color: #9b59b6;
            background: #f3e5f5;
        }

        .bed-card.available {
            border-left-color: #95a5a6;
            background: #ecf0f1;
        }

        .bed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .bed-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #2d3436;
        }

        .bed-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .bed-status.level1,
        .bed-status.level2 {
            background: #e74c3c;
            color: white;
        }

        .bed-status.level3 {
            background: #f39c12;
            color: white;
        }

        .bed-status.level4,
        .bed-status.level5 {
            background: #27ae60;
            color: white;
        }

        .bed-status.no-triase {
            background: #9b59b6;
            color: white;
        }

        .bed-status.available {
            background: #95a5a6;
            color: white;
        }

        .patient-info {
            margin-bottom: 15px;
        }

        .patient-info p {
            margin: 5px 0;
            color: #636e72;
        }

        .patient-info strong {
            color: #2d3436;
        }

        .los-badge {
            display: inline-block;
            background: #fdcb6e;
            color: #2d3436;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 5px;
        }

        .los-badge.critical {
            background: #e84393;
            color: white;
        }

        .bed-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            font-size: 0.9em;
        }

        .btn-admisi {
            background: #00b894;
            color: white;
        }

        .btn-hentikan {
            background: #e17055;
            color: white;
        }

        .btn-edit {
            background: #74b9ff;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .rekap-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .rekap-table th {
            background: #74b9ff;
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
        }

        .rekap-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }

        .rekap-table tr:hover {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-header h2 {
            color: #2d3436;
            font-size: 1.5em;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #636e72;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3436;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #74b9ff;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-secondary {
            background: #636e72;
            color: white;
        }

        .btn-danger {
            background: #e17055;
            color: white;
        }

        .btn-success {
            background: #00b894;
            color: white;
        }

        .hide {
            display: none !important;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .rekap-table {
                font-size: 0.8em;
            }

            .rekap-table th,
            .rekap-table td {
                padding: 8px 5px;
            }
.btn-sm {
  padding: 5px 10px;
  font-size: 0.8em;
  border-radius: 6px;
}

.btn-primary {
  background: #74b9ff;
  color: white;
  border: none;
}

            
        }
        
    </style>
<!-- Tambahkan sebelum </head> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <h1>Dashboard TT dan LOS IGD Hermina Solo</h1>
                <div class="datetime" id="datetime"></div>
            </div>
            <button class="settings-btn" onclick="openMasterData()">
                <span style="font-size: 1.5em;">⋮</span>
            </button>
        </div>

        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-btn active" onclick="showDashboard()">📊 Dashboard TT dan LOS</button>
            <button class="nav-btn" onclick="showRekap()">📋 Rekap Data Pasien</button>
        </div>

        <!-- Content -->
        <div class="content">
            <!-- Dashboard TT dan LOS -->
            <div id="dashboard-content">
                <h2>Status Tempat Tidur IGD</h2>
                <div class="dashboard-grid" id="bedGrid">
                    <!-- Bed cards akan di-generate oleh JavaScript -->
                </div>
            </div>

            <!-- Rekap Data Pasien -->
            <div id="rekap-content" class="hide">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <h2>Rekap Data Pasien</h2>
  <div style="display: flex; align-items: center; gap: 10px;">
    <input type="date" id="tglAwal" class="btn-sm">
    <input type="date" id="tglAkhir" class="btn-sm">
    <button class="btn btn-primary btn-sm" onclick="filterByDate()">Filter</button>
    <button class="btn btn-success btn-sm" onclick="exportToExcel()">📊 Export</button>
    <button class="btn btn-primary btn-sm" onclick="testConnection()">Test Koneksi</button>
  </div>
</div>

                <div style="overflow-x: auto;">
                    <table class="rekap-table">
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Tgl Masuk</th>
                                <th>Bed</th>
                                <th>MRN</th>
                                <th>Nama Pasien</th>
                                <th>Jenis Pasien<br>(B/L)</th>

                                <th>JK</th>
                                <th>Usia</th>
                                <th>Jam Datang</th>
                                <th>Jam Selesai</th>
                                <th>LOS</th>
                                <th>Triase</th>
                                <th>Diagnosa</th>
                                <th>Cara Datang</th>
                                <th>Asal Rujukan</th>
                                <th>Jaminan</th>
                                <th>Status Rawat</th>
                                <th>Ruang Rawat</th>
                                <th>Kelas</th>
                                <th>DPJP</th>
                                <th>Tindakan</th>
                                <th>Perawat/Bidan</th>
                                <th>Dokter Jaga</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="rekapTableBody">
                            <!-- Data akan di-generate oleh JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Master Data -->
<div id="masterDataModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Master Data</h2>
      <button class="close-btn" onclick="closeMasterData()">&times;</button>
    </div>

    <label>Pilih Kategori:</label>
    <select id="masterCategory">
      <option value="caraDatang">Cara Datang</option>
      <option value="asalRujukan">Asal Rujukan</option>
      <option value="jaminan">Jaminan</option>
      <option value="statusRawat">Status Rawat</option>
      <option value="ruangRawat">Ruang Rawat</option>
      <option value="kelas">Kelas</option>
      <option value="dpjp">DPJP</option>
      <option value="perawat">Perawat/Bidan</option>
      <option value="dokterJaga">Dokter Jaga</option>
    </select>

    <label>Tambah Data:</label>
    <input type="text" id="newMasterValue">
    <button onclick="addMasterData()">Tambah</button>

    <h3>Daftar</h3>
    <ul id="masterList"></ul>
  </div>
</div>


    <!-- Modal Admisi - HANYA NAMA SAJA -->
    <div id="admisiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Admisi Pasien</h2>
                <button class="close-btn" onclick="closeAdmisi()">&times;</button>
            </div>
            <form id="admisiForm">
                <div class="form-group">
                    <label>Nama Pasien / Kriteria:</label>
                    <input type="text" id="admisiNama" required placeholder="Masukkan nama pasien">
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeAdmisi()">Batal</button>
                    <button type="submit" class="btn btn-success">Mulai Admisi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Hentikan -->
    <div id="hentikanModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Hentikan Perawatan</h2>
                <button class="close-btn" onclick="closeHentikan()">&times;</button>
            </div>
            <div class="action-buttons">
                <button type="button" class="btn btn-success" onclick="showPindahkan()">Pindahkan</button>
                <button type="button" class="btn btn-danger" onclick="showHentikan()">Hentikan</button>
            </div>
            
            <!-- Sub-options untuk Pindahkan -->
            <div id="pindahkanOptions" class="hide" style="margin-top: 20px;">
                <div style="margin-bottom: 15px;">
                    <div class="form-group">
    <label>DPJP:</label>
    <input list="dpjpList" id="dpjp" required>
</div>
<div class="form-row">
    <div class="form-group">
        <label>Ruang Rawat:</label>
        <input list="ruangRawatList" id="ruangRawat" required>
    </div>
    <div class="form-group">
        <label>Kelas:</label>
        <input list="kelasList" id="kelas" required>
    </div>
</div>

                </div>
                <h3>Pindah ke:</h3>
                <div class="action-buttons">
                    <button type="button" class="btn btn-success" id="btnRWI" onclick="prosesSelesai('RWI')" disabled>RWI</button>
                    <button type="button" class="btn btn-success" id="btnODC" onclick="prosesSelesai('ODC')" disabled>ODC</button>
                </div>
            </div>
            
            <!-- Sub-options untuk Hentikan -->
            <div id="hentikanOptions" class="hide" style="margin-top: 20px;">
                <h3>Status Akhir:</h3>
                <div class="action-buttons">
                    <button type="button" class="btn btn-success" onclick="prosesSelesai('RWJ/Pulang')">RWJ/Pulang</button>
                    <button type="button" class="btn btn-secondary" onclick="prosesSelesai('APS')">APS</button>
                    <button type="button" class="btn btn-danger" onclick="prosesSelesai('DOA')">DOA</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Edit Pasien -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Data Pasien</h2>
                <button class="close-btn" onclick="closeEdit()">&times;</button>
            </div>
            <form id="editForm">
                <div class="form-row">
                    <div class="form-group">
                        <label>MRN:</label>
                        <input type="text" id="editMRN">
                    </div>
                    <div class="form-group">
                        <label>Nama Lengkap:</label>
                        <input type="text" id="editNama">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Pasien:</label>
                        <select id="editPasien">
                            <option value="Baru">Baru</option>
                            <option value="Lama">Lama</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Jenis Kelamin:</label>
                        <select id="editJK">
                            <option value="L">Laki-laki</option>
                            <option value="P">Perempuan</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tanggal Lahir:</label>
                        <input type="date" id="editTglLahir">
                    </div>
                    <div class="form-group">
                        <label>Usia (otomatis):</label>
                        <input type="text" id="editUsiaDisplay" readonly>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Triase:</label>
                        <select id="editTriase">
                            <option value="">Pilih Triase</option>
                            <option value="Level 1">Level 1</option>
                            <option value="Level 2">Level 2</option>
                            <option value="Level 3">Level 3</option>
                            <option value="Level 4">Level 4</option>
                            <option value="Level 5">Level 5</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Cara Datang:</label>
                        <select id="editCaraDatang">
                            <option value="">Pilih...</option>
                            <option value="Jalan Kaki">Jalan Kaki</option>
                            <option value="Kursi Roda">Kursi Roda</option>
                            <option value="Brankar">Brankar</option>
                            <option value="Ambulan">Ambulan</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Asal Rujukan:</label>
                        <input list="asalRujukanList" id="editAsalRujukan">
                    </div>
                    <div class="form-group">
                        <label>Jaminan:</label>
                        <select id="editJaminan">
                            <option value="">Pilih...</option>
                            <option value="BPJS">BPJS</option>
                            <option value="Umum">Umum</option>
                            <option value="Asuransi">Asuransi</option>
                            <option value="Jamkesda">Jamkesda</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
  <label>Diagnosa:</label>
  <input type="text" id="editDiagnosa">
</div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Tindakan:</label>
                        <input type="text" id="editTindakan">
                    </div>
                    <div class="form-group">
                        <label>Perawat / Bidan:</label>
                        <input list="perawatList" id="editPerawat">
                    </div>
                    <div class="form-group">
                        <label>Dokter Jaga:</label>
                         <input list="dokterJagaList" id="editDokterJaga">
                    </div>
                    <div class="form-group"></div>
                </div>
                <div class="action-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeEdit()">Batal</button>
                    <button type="submit" class="btn btn-success">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentBed = null;
        let bedData = {};
        let patientData = [];

        // Tambahkan di sini (GLOBAL, bukan di dalam init)
        let masterData = {
            triase: ["Level 1", "Level 2", "Level 3", "Level 4", "Level 5"],
            caraDatang: ["Jalan Kaki", "Kursi Roda", "Brankar", "Ambulan"],
            asalRujukan: ["RS A", "RS B", "Puskesmas", "Klinik"],
            jaminan: ["BPJS", "Umum", "Asuransi", "Jamkesda"],
            statusRawat: ["IGD", "Rawat Inap", "Rawat Jalan"],
            ruangRawat: ["ICU", "HCU", "VIP", "Kelas I", "Kelas II", "Kelas III"],
            kelas: ["VIP", "Kelas 1", "Kelas 2", "Kelas 3"],
            dpjp: ["Dr. Andi", "Dr. Budi", "Dr. Sari"],
            perawat: ["Suster Lina", "Suster Rina"],
            dokterJaga: ["Dr. Joko", "Dr. Dina"]
};


        // Konfigurasi Google Sheets
        const GOOGLE_SHEET_ID = '1vku1XBok2010xMUIWG8iUMZSY3_EE0fsx2FIknCidAQ';
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxshvOe5Teptt-0jWLgNe0DAEG-4sdgfWBnIVXqTaDqLmfABfPw9DHOTV-MV6ggrGq2/exec';

        // Daftar tempat tidur IGD
        const bedList = [
            'Padma-01', 'Padma-02', 'Padma-03', 'Padma-04', 'Padma-05', 'Padma-06','Padma-07','Padma-08','Padma-09','Padma-10',
            'Kamala-01', 'Kamala-02', 'Kamala-03', 'Kamala-04', 'Kamala-05', 'Kamala-06', 'Kamala-07', 'Kamala-08', 'Kamala-09', 'Kamala-10','Kamala-11',
            'Isolasi-01', 'PONEK-01', 'PONEK-02', 'Triase-01'
        ];

        // Initialize application
        function init() {
            updateDateTime();
            generateBedCards();
            loadPatientData();
            refreshDatalists();   // ⬅️ tambahkan ini

            let masterData = {
                triase: ["Level 1", "Level 2", "Level 3", "Level 4", "Level 5"],
                caraDatang: ["Jalan Kaki", "Kursi Roda", "Brankar", "Ambulan"],
                asalRujukan: ["RS A", "RS B", "Puskesmas", "Klinik"],
                jaminan: ["BPJS", "Umum", "Asuransi", "Jamkesda"],
                statusRawat: ["IGD", "Rawat Inap", "Rawat Jalan"],
                ruangRawat: ["ICU", "HCU", "VIP", "Kelas I", "Kelas II", "Kelas III"],
                kelas: ["VIP", "Kelas 1", "Kelas 2", "Kelas 3"],
                dpjp: ["Dr. Andi", "Dr. Budi", "Dr. Sari"],
                perawat: ["Suster Lina", "Suster Rina"],
                dokterJaga: ["Dr. Joko", "Dr. Dina"]
};

            
            // Update datetime dan LOS setiap detik
            setInterval(() => {
                updateDateTime();
                generateBedCards(); // Update LOS yang berjalan
            }, 1000);
            
            // Setup form validation untuk pindahkan
            setupPindahkanValidation();
        }

        // Update tanggal dan jam
        function updateDateTime() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            };
            document.getElementById('datetime').textContent = now.toLocaleDateString('id-ID', options);
        }

function refreshDatalists() {
  for (const key in masterData) {
    const datalistId = key + "List";
    let datalist = document.getElementById(datalistId);
    if (!datalist) {
      datalist = document.createElement("datalist");
      datalist.id = datalistId;
      document.body.appendChild(datalist);
    }
    datalist.innerHTML = masterData[key]
      .map(item => `<option value="${item}">`)
      .join("");
  }
}

function addMasterData() {
  const category = document.getElementById('masterCategory').value;
  const value = document.getElementById('newMasterValue').value.trim();
  if (value && !masterData[category].includes(value)) {
    masterData[category].push(value);
    refreshDatalists();
    showMasterList();
    document.getElementById('newMasterValue').value = '';
  }
}

function showMasterList() {
  const category = document.getElementById('masterCategory').value;
  const listEl = document.getElementById('masterList');
  listEl.innerHTML = '';
  masterData[category].forEach((item, idx) => {
    const li = document.createElement('li');
    li.innerHTML = `
      ${item} 
      <button onclick="deleteMasterData('${category}', ${idx})" 
              style="margin-left:10px; color:red; cursor:pointer; background:none; border:none;">
        ❌
      </button>
    `;
    listEl.appendChild(li);
  });
}

function deleteMasterData(category, index) {
  if (masterData[category]) {
    masterData[category].splice(index, 1);   // hapus item dari array
    refreshDatalists();                      // update <datalist>
    showMasterList();                        // update tampilan daftar
  }
}



document.addEventListener('DOMContentLoaded', () => {
  const cat = document.getElementById('masterCategory');
  if (cat) {
    cat.addEventListener('change', showMasterList);
  }
});


        // Generate bed cards
        function generateBedCards() {
    const bedGrid = document.getElementById('bedGrid');
    bedGrid.innerHTML = '';

    const zones = {
        "Padma": bedList.filter(b => b.startsWith('Padma')),
        "Kamala": bedList.filter(b => b.startsWith('Kamala')),
        "Lainnya": bedList.filter(b =>
            !b.startsWith('Padma') && !b.startsWith('Kamala')
        )
    };

    for (const [zoneName, beds] of Object.entries(zones)) {
        // Tambah header zona sebagai elemen full-width
        const header = document.createElement('div');
        header.textContent = `Zona ${zoneName}`;
        header.style.gridColumn = '1 / -1';   // supaya header memenuhi 1 baris penuh
        header.style.fontWeight = 'bold';
        header.style.fontSize = '1.3em';
        header.style.marginTop = '20px';
        header.style.color = '#2d3436';
        bedGrid.appendChild(header);

        // Lanjutkan append bed-card sesuai urutan
        beds.forEach(bedName => {
            const bedCard = createBedCard(bedName);
            bedGrid.appendChild(bedCard);
        });
    }
}



        // Create individual bed card
        function createBedCard(bedName) {
            const card = document.createElement('div');
            const bed = bedData[bedName] || { status: 'available' };
            
            // Determine bed class based on triase level
            let bedClass = 'available';
            let statusText = 'Kosong';
            let statusClass = 'available';
            
            if (bed.status === 'occupied') {
                if (bed.triase) {
                    const triaseLevel = bed.triase.toLowerCase();
                    if (triaseLevel.includes('level 1') || triaseLevel.includes('level 2')) {
                        bedClass = 'level1';
                        statusClass = 'level1';
                    } else if (triaseLevel.includes('level 3')) {
                        bedClass = 'level3';
                        statusClass = 'level3';
                    } else if (triaseLevel.includes('level 4') || triaseLevel.includes('level 5')) {
                        bedClass = 'level4';
                        statusClass = 'level4';
                    }
                    statusText = `Terisi - ${bed.triase}`;
                } else {
                    bedClass = 'no-triase';
                    statusClass = 'no-triase';
                    statusText = 'Terisi - Belum Triase';
                }
            }
            
            card.className = `bed-card ${bedClass}`;
            card.innerHTML = `
                <div class="bed-header">
                    <div class="bed-name">${bedName}</div>
                    <div class="bed-status ${statusClass}">
                        ${statusText}
                    </div>
                </div>
                <div class="patient-info">
                    ${bed.status === 'occupied' ? `
                        <p><strong>Nama:</strong> ${bed.nama || '-'}</p>
                        <p><strong>Usia:</strong> ${bed.usia || 'Belum diisi'} ${bed.usia ? 'tahun' : ''}</p>
                        <p><strong>Triase:</strong> ${bed.triase || 'Belum diisi'}</p>
                        <div class="los-badge ${calculateLOSHours(bed.jamDatang) > 6 ? 'critical' : ''}">
                            LOS: ${formatLOSRunning(bed.jamDatang)}
                        </div>
                    ` : '<p style="color: #636e72; font-style: italic;">Tempat tidur tersedia</p>'}
                </div>
                <div class="bed-actions">
                    ${bed.status === 'available' ? `
                        <button class="btn btn-admisi" onclick="openAdmisi('${bedName}')">Admisi</button>
                    ` : `
                        <button class="btn btn-hentikan" onclick="openHentikan('${bedName}')">Hentikan</button>
                        <button class="btn btn-edit" onclick="openEdit('${bedName}')">Edit</button>
                    `}
                </div>
            `;
            
            return card;
        }

        // Calculate LOS in hours (for threshold checking)
        function calculateLOSHours(jamDatang) {
            if (!jamDatang) return 0;
            const now = new Date();
            const startTime = new Date(jamDatang);
            return Math.floor((now - startTime) / (1000 * 60 * 60));
        }

        // Format LOS as running duration (hh:mm:ss)
        function formatLOSRunning(jamDatang) {
            if (!jamDatang) return '00:00:00';
            
            const now = new Date();
            const startTime = new Date(jamDatang);
            const diffMs = now - startTime;
            
            if (diffMs < 0) return '00:00:00';
            
            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Navigation functions
        function showDashboard() {
            document.getElementById('dashboard-content').classList.remove('hide');
            document.getElementById('rekap-content').classList.add('hide');
            document.querySelectorAll('.nav-btn')[0].classList.add('active');
            document.querySelectorAll('.nav-btn')[1].classList.remove('active');
        }

        function showRekap() {
            document.getElementById('dashboard-content').classList.add('hide');
            document.getElementById('rekap-content').classList.remove('hide');
            document.querySelectorAll('.nav-btn')[0].classList.remove('active');
            document.querySelectorAll('.nav-btn')[1].classList.add('active');
            loadRekapTable();
        }

        // Modal functions
        function openMasterData() {
            document.getElementById('masterDataModal').style.display = 'block';
        }

        function closeMasterData() {
            document.getElementById('masterDataModal').style.display = 'none';
        }

        function openAdmisi(bedName) {
            currentBed = bedName;
            document.getElementById('admisiModal').style.display = 'block';
        }

        function closeAdmisi() {
            document.getElementById('admisiModal').style.display = 'none';
            document.getElementById('admisiForm').reset();
        }

        function openHentikan(bedName) {
            currentBed = bedName;
            document.getElementById('hentikanModal').style.display = 'block';
        }

        function closeHentikan() {
            document.getElementById('hentikanModal').style.display = 'none';
            document.getElementById('pindahkanOptions').classList.add('hide');
            document.getElementById('hentikanOptions').classList.add('hide');
        }

        function showPindahkan() {
            document.getElementById('pindahkanOptions').classList.remove('hide');
            document.getElementById('hentikanOptions').classList.add('hide');
            // Reset dan validate form
            validatePindahkanForm();
        }

        function setupPindahkanValidation() {
            const inputs = ['dpjp', 'ruangRawat', 'kelas'];
            inputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', validatePindahkanForm);
                    element.addEventListener('change', validatePindahkanForm);
                }
            });
        }

        function validatePindahkanForm() {
            const dpjp = document.getElementById('dpjp').value.trim();
            const ruangRawat = document.getElementById('ruangRawat').value.trim();
            const kelas = document.getElementById('kelas').value.trim();
            
            const isValid = dpjp && ruangRawat && kelas;
            
            document.getElementById('btnRWI').disabled = !isValid;
            document.getElementById('btnODC').disabled = !isValid;
        }

        function showHentikan() {
            document.getElementById('hentikanOptions').classList.remove('hide');
            document.getElementById('pindahkanOptions').classList.add('hide');
        }

        function openEdit(bedName) {
            currentBed = bedName;
            const bed = bedData[bedName];
            if (bed) {
                document.getElementById('editNama').value = bed.nama || '';
                document.getElementById('editMRN').value = bed.mrn || '';
                document.getElementById('editPasien').value = bed.pasien || 'Baru';
                document.getElementById('editJK').value = bed.jk || 'L';
                document.getElementById('editTglLahir').value = bed.tglLahir || '';
                document.getElementById('editTriase').value = bed.triase || '';
                document.getElementById('editDiagnosa').value = bed.diagnosa || '';
                document.getElementById('editCaraDatang').value = bed.caraDatang || '';
                document.getElementById('editAsalRujukan').value = bed.asalRujukan || '';
                document.getElementById('editJaminan').value = bed.jaminan || '';
                document.getElementById('editTindakan').value = bed.tindakan || '';
                document.getElementById('editPerawat').value = bed.perawat || '';
                document.getElementById('editDokterJaga').value = bed.dokterJaga || '';
                
                // Calculate and display age
                if (bed.tglLahir) {
                    const age = calculateAge(bed.tglLahir);
                    document.getElementById('editUsiaDisplay').value = age + ' tahun';
                }
            }
            document.getElementById('editModal').style.display = 'block';
        }

        function closeEdit() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editForm').reset();
        }

        // Calculate age from birth date
        function calculateAge(dob) {
  const birthDate = new Date(dob);
  const today = new Date();

  let years = today.getFullYear() - birthDate.getFullYear();
  let months = today.getMonth() - birthDate.getMonth();
  let days = today.getDate() - birthDate.getDate();

  // Atur pinjaman hari
  if (days < 0) {
    months--;
    const prevMonth = new Date(today.getFullYear(), today.getMonth(), 0).getDate();
    days += prevMonth;
  }

  // Atur pinjaman bulan
  if (months < 0) {
    years--;
    months += 12;
  }

  if (years >= 1) {
    return `${years} th ${months} bl`;
  } else {
    return `${months} bl ${days} hr`;
  }
}

function filterByDate() {
  const tglAwal = document.getElementById("tglAwal").value;
  const tglAkhir = document.getElementById("tglAkhir").value;

  if (!tglAwal || !tglAkhir) {
    alert("Pilih rentang tanggal terlebih dahulu.");
    return;
  }

  const start = new Date(tglAwal);
  const end = new Date(tglAkhir);
  end.setHours(23,59,59,999); // biar sampai akhir hari

  const filtered = patientData.filter(p => {
    if (!p.tglMasuk) return false;
    const masuk = new Date(p.tglMasuk);
    return masuk >= start && masuk <= end;
  });

  loadRekapTable(filtered);
}



// Tambahkan fungsi ini di bagian akhir JavaScript

function exportToExcel() {
    try {
        // Header kolom sesuai tabel
        const headers = [
            'No', 'Tgl Masuk', 'Bed', 'MRN', 'Nama Pasien', 'Jenis Pasien (B/L)', 
            'JK', 'Usia', 'Jam Datang', 'Jam Selesai', 'LOS', 'Triase', 
            'Diagnosa', 'Cara Datang', 'Asal Rujukan', 'Jaminan', 
            'Status Rawat', 'Ruang Rawat', 'Kelas', 'DPJP', 'Tindakan', 
            'Perawat/Bidan', 'Dokter Jaga'
        ];

        // Data dari patientData
        const data = patientData.map((patient, index) => [
            index + 1,
            patient.tglMasuk || '-',
            patient.tempat || '-',
            patient.mrn || '-',
            patient.nama || '-',
            patient.pasien ? (patient.pasien === 'Baru' ? 'B' : 'L') : '-',
            patient.jk || '-',
            patient.usia || '-',
            formatTime(patient.jamDatang),
            formatTime(patient.jamSelesai),
            patient.los || '-',
            patient.triase || '-',
            patient.diagnosa || '-',
            patient.caraDatang || '-',
            patient.asalRujukan || '-',
            patient.jaminan || '-',
            patient.statusRawat || '-',
            patient.ruangRawat || '-',
            patient.kelas || '-',
            patient.dpjp || '-',
            patient.tindakan || '-',
            patient.perawat || '-',
            patient.dokterJaga || '-'
        ]);

        // Gabungkan header dan data
        const worksheetData = [headers, ...data];

        // Buat workbook dan worksheet
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);

        // Set width kolom
        const colWidths = [
            {wch: 5},   // No
            {wch: 12},  // Tgl Masuk
            {wch: 12},  // Bed
            {wch: 10},  // MRN
            {wch: 20},  // Nama Pasien
            {wch: 8},   // Jenis Pasien
            {wch: 5},   // JK
            {wch: 12},  // Usia
            {wch: 12},  // Jam Datang
            {wch: 12},  // Jam Selesai
            {wch: 10},  // LOS
            {wch: 10},  // Triase
            {wch: 25},  // Diagnosa
            {wch: 12},  // Cara Datang
            {wch: 15},  // Asal Rujukan
            {wch: 10},  // Jaminan
            {wch: 12},  // Status Rawat
            {wch: 15},  // Ruang Rawat
            {wch: 8},   // Kelas
            {wch: 15},  // DPJP
            {wch: 20},  // Tindakan
            {wch: 15},  // Perawat/Bidan
            {wch: 15}   // Dokter Jaga
        ];
        worksheet['!cols'] = colWidths;

        // Style header
        const headerStyle = {
            font: { bold: true, color: { rgb: "FFFFFF" } },
            fill: { fgColor: { rgb: "4472C4" } },
            alignment: { horizontal: "center", vertical: "center" }
        };

        // Apply style ke header (row pertama)
        for (let col = 0; col < headers.length; col++) {
            const cellRef = XLSX.utils.encode_cell({ r: 0, c: col });
            if (!worksheet[cellRef]) worksheet[cellRef] = {};
            worksheet[cellRef].s = headerStyle;
        }

        // Tambah worksheet ke workbook
        XLSX.utils.book_append_sheet(workbook, worksheet, "Data IGD");

        // Generate nama file dengan tanggal
        const today = new Date();
        const dateStr = today.toISOString().split('T')[0];
        const timeStr = today.toTimeString().split(' ')[0].replace(/:/g, '-');
        const filename = `Rekap_IGD_Hermina_Solo_${dateStr}_${timeStr}.xlsx`;

        // Download file
        XLSX.writeFile(workbook, filename);
        
        console.log('Excel file exported successfully:', filename);
        
        // Optional: tampilkan notifikasi berhasil
        alert(`Data berhasil di-export ke file: ${filename}`);

    } catch (error) {
        console.error('Error exporting to Excel:', error);
        alert('Gagal export data. Silakan coba lagi.');
    }
}


        // Form submissions
        document.getElementById('admisiForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  
  const nama = document.getElementById('admisiNama').value.trim();
  if (!nama) {
    alert('Nama pasien harus diisi');
    return;
  }
  
  // Buat data pasien baru
  const newPatient = {
    status: 'occupied',
    bedId: currentBed,
    tempat: currentBed,
    nama: nama,
    jamDatang: new Date().toISOString(),
    tglMasuk: new Date().toLocaleDateString('id-ID'),
    pasien: 'Baru'
  };

  // Update bedData
  bedData[currentBed] = newPatient;
  
  // Simpan ke Google Sheets
  const saveResult = await saveToGoogleSheets(newPatient, 'save');
  
  if (saveResult.result === 'success') {
    // Tambahkan ke patientData
    patientData.push(newPatient);
    
    // Refresh tampilan
    generateBedCards();
    loadRekapTable(patientData);
    closeAdmisi();
    
    console.log('Admisi berhasil disimpan');
  } else {
    alert('Gagal menyimpan data: ' + saveResult.message);
    console.error('Gagal menyimpan admisi:', saveResult);
  }
});

        async function loadDataFromSheets() {
  try {
    const resp = await fetch(GOOGLE_SCRIPT_URL);
    const json = await resp.json();
    return json.data;  // data array dari Sheets
  } catch (err) {
    console.error('Error load data:', err);
    return [];
  }
}

async function saveRowToSheets(rowArray) {
  try {
    const resp = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'save', row: rowArray })
    });
    return await resp.json();
  } catch (err) {
    console.error('Error save:', err);
    return { result: 'error' };
  }
}

async function updateRowInSheets(rowIndex, rowArray) {
  try {
    const resp = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'update', rowIndex, row: rowArray })
    });
    return await resp.json();
  } catch (err) {
    console.error('Error update:', err);
    return { result: 'error' };
  }
}

async function saveToGoogleSheets(patientObj, action) {
  // Pastikan GOOGLE_SCRIPT_URL sudah diset dengan benar
  if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes('MASUKKAN_URL')) {
    console.error('URL Apps Script belum diset');
    return { result: 'error', message: 'URL Apps Script belum dikonfigurasi' };
  }

  const row = [
    '', // No - auto generate
    patientObj.tglMasuk || new Date().toLocaleDateString('id-ID'),
    patientObj.bedId || patientObj.tempat || '',
    patientObj.mrn || '',
    patientObj.nama || '',
    patientObj.pasien === 'Baru' ? 'B' : (patientObj.pasien === 'Lama' ? 'L' : ''),
    patientObj.jk || '',
    patientObj.usia || '',
    patientObj.jamDatang || '',
    patientObj.jamSelesai || '',
    patientObj.los || '',
    patientObj.triase || '',
    patientObj.diagnosa || '',
    patientObj.caraDatang || '',
    patientObj.asalRujukan || '',
    patientObj.jaminan || '',
    patientObj.statusRawat || '',
    patientObj.ruangRawat || '',
    patientObj.kelas || '',
    patientObj.dpjp || '',
    patientObj.tindakan || '',
    patientObj.perawat || '',
    patientObj.dokterJaga || ''
  ];

  try {
    const payload = { 
      action: action, 
      row: row 
    };
    
    if (action === 'update' && typeof patientObj.rowIndex === 'number') {
      payload.rowIndex = patientObj.rowIndex;
    }

    const response = await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    console.log('Save result:', result);
    return result;
    
  } catch (error) {
    console.error('Error save to sheets:', error);
    return { result: 'error', message: error.message };
  }
}


        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!bedData[currentBed]) return;
            
            // Update bed data dengan informasi lengkap
            const currentData = bedData[currentBed];
            currentData.mrn = document.getElementById('editMRN').value;
            currentData.nama = document.getElementById('editNama').value;
            currentData.pasien = document.getElementById('editPasien').value;
            currentData.jk = document.getElementById('editJK').value;
            currentData.tglLahir = document.getElementById('editTglLahir').value;
            currentData.triase = document.getElementById('editTriase').value;
            currentData.caraDatang = document.getElementById('editCaraDatang').value;
            currentData.asalRujukan = document.getElementById('editAsalRujukan').value;
            currentData.jaminan = document.getElementById('editJaminan').value;
            currentData.tindakan = document.getElementById('editTindakan').value;
            currentData.perawat = document.getElementById('editPerawat').value;
            currentData.dokterJaga = document.getElementById('editDokterJaga').value;
            currentData.diagnosa = document.getElementById('editDiagnosa').value;

            
            // Calculate age from birth date
            if (currentData.tglLahir) {
                currentData.usia = calculateAge(currentData.tglLahir);
            }
            
            // cari data pasien di patientData
const patientIndex = patientData.findIndex(p => 
    p.tempat === currentBed && !p.jamSelesai
);

if (patientIndex >= 0) {
    const updatedPatient = { ...currentData, tempat: currentBed, rowIndex: patientData[patientIndex].rowIndex };
    patientData[patientIndex] = updatedPatient;
    saveToGoogleSheets(updatedPatient, 'update');  // <-- rowIndex ikut terkirim
} else {
    patientData.push({ ...currentData, tempat: currentBed });
    saveToGoogleSheets(currentData, 'save'); // kalau data baru
}



// Refresh display
generateBedCards();
loadRekapTable(patientData);
closeEdit();
            
 });

        // Auto-calculate age when birth date changes
        document.getElementById('editTglLahir').addEventListener('change', function() {
            const birthDate = this.value;
            if (birthDate) {
                const age = calculateAge(birthDate);
                document.getElementById('editUsiaDisplay').value = age + ' tahun';
            }
        });

        // Process completion (Hentikan/Pindahkan)
        function prosesSelesai(statusRawat) {
  if (!currentBed) return;

  // cari record di patientData untuk bed ini (yang belum selesai)
  const pIndex = patientData.findIndex(p => p.tempat === currentBed && !p.jamSelesai);

  // mulai dari bedData jika ada, atau dari patientData bila bedData kosong
  let currentData = bedData[currentBed] ? { ...bedData[currentBed] } : (pIndex >= 0 ? { ...patientData[pIndex] } : null);
  if (!currentData) {
    // tidak ada data pasien untuk diproses
    console.warn('Tidak ada data pasien untuk bed', currentBed);
    return;
  }

  // set jam selesai & status
  currentData.jamSelesai = new Date().toISOString();
  currentData.statusRawat = statusRawat;

  // hitung LOS
  const jamDatang = new Date(currentData.jamDatang || currentData.tglMasuk || new Date().toISOString());
  const jamSelesai = new Date(currentData.jamSelesai);
  const diffMs = jamSelesai - jamDatang;
  const hours = Math.floor(diffMs / (1000 * 60 * 60));
  const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
  const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
  currentData.los = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

  // Jika pindah, ambil data tambahan dari form (jika ada) — jika kosong, jangan timpa nilai lama
  if (statusRawat === 'RWI' || statusRawat === 'ODC') {
    const dpjpVal = document.getElementById('dpjp').value;
    const ruangVal = document.getElementById('ruangRawat').value;
    const kelasVal = document.getElementById('kelas').value;
    if (dpjpVal) currentData.dpjp = dpjpVal;
    if (ruangVal) currentData.ruangRawat = ruangVal;
    if (kelasVal) currentData.kelas = kelasVal;
  }

  // update patientData (update baris yang sudah ada atau push baru)
  if (pIndex >= 0) {
    patientData[pIndex] = { ...currentData, tempat: currentBed };
  } else {
    patientData.push({ ...currentData, tempat: currentBed });
  }

  // hapus bed karena pasien pindah/selesai
  delete bedData[currentBed];

  // refresh UI
  generateBedCards();
  loadRekapTable(patientData);
  closeHentikan();

  // optional: simpan ke Google Sheets
  saveToGoogleSheets(currentData, 'update');
}


        // Load rekap table
 // fungsi bantu format jam
  function formatTime(value) {
    if (!value) return '-';
    const d = new Date(value);
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    const ss = String(d.getSeconds()).padStart(2, '0');
    return `${hh}:${mm}:${ss}`;
  }

     function loadRekapTable(data = patientData) {
  const tbody = document.getElementById('rekapTableBody');
  tbody.innerHTML = '';

  data.forEach((patient, index) => {
    const row = tbody.insertRow();

    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${patient.tglMasuk || '-'}</td>
      <td>${patient.tempat || '-'}</td>
      <td>${patient.mrn || '-'}</td>
      <td>${patient.nama || '-'}</td>
      <td>${patient.pasien ? (patient.pasien === 'Baru' ? 'B' : 'L') : '-'}</td>
      <td>${patient.jk || '-'}</td>
      <td>${patient.usia || '-'}</td>
      <td>${formatTime(patient.jamDatang)}</td>
      <td>${formatTime(patient.jamSelesai)}</td>
      <td>${patient.los || '-'}</td>
      <td>${patient.triase || '-'}</td>
      <td>${patient.diagnosa || '-'}</td>
      <td>${patient.caraDatang || '-'}</td>
      <td>${patient.asalRujukan || '-'}</td>
      <td>${patient.jaminan || '-'}</td>
      <td>${patient.statusRawat || '-'}</td>
      <td>${patient.ruangRawat || '-'}</td>
      <td>${patient.kelas || '-'}</td>
      <td>${patient.dpjp || '-'}</td>
      <td>${patient.tindakan || '-'}</td>
      <td>${patient.perawat || '-'}</td>
      <td>${patient.dokterJaga || '-'}</td>
      <td></td>
    `;

    // kolom aksi
    const actionCell = row.lastElementChild;

    // tombol Edit
    const editBtn = document.createElement('button');
    editBtn.textContent = 'Edit';
    editBtn.className = 'btn btn-edit';
    editBtn.onclick = () => enableInlineEdit(row, patient, index);
    actionCell.appendChild(editBtn);
  });
}

function enableInlineEdit(row, patient, index) {
  const cells = row.querySelectorAll("td");

  // MRN
  cells[3].innerHTML = `<input type="text" value="${patient.mrn || ''}" style="width:100%">`;

  // Nama
  cells[4].innerHTML = `<input type="text" value="${patient.nama || ''}" style="width:100%">`;

// Jenis Pasien (B/L)
cells[5].innerHTML = `
  <select style="width:100%">
    <option value="">-</option>
    <option value="Baru" ${patient.pasien === 'Baru' ? 'selected' : ''}>Baru</option>
    <option value="Lama" ${patient.pasien === 'Lama' ? 'selected' : ''}>Lama</option>
  </select>
`;

// JK
cells[6].innerHTML = `
  <select style="width:100%">
    <option value="L" ${patient.jk === 'L' ? 'selected' : ''}>Laki-laki</option>
    <option value="P" ${patient.jk === 'P' ? 'selected' : ''}>Perempuan</option>
  </select>
`;

// Usia (pakai input tanggal lahir)
cells[7].innerHTML = `<input type="date" value="${patient.tglLahir || ''}" style="width:100%">`;

  // Triase
cells[11].innerHTML = `
  <input list="triaseList" value="${patient.triase || ''}" style="width:100%">
`;

  // Diagnosa
  cells[12].innerHTML = `<input type="text" value="${patient.diagnosa || ''}" style="width:100%">`;

  // Cara Datang
cells[13].innerHTML = `
  <input list="caraDatangList" value="${patient.caraDatang || ''}" style="width:100%">
`;


  // Asal Rujukan
cells[14].innerHTML = `
  <input list="asalRujukanList" value="${patient.asalRujukan || ''}" style="width:100%">
`;


  // Jaminan
cells[15].innerHTML = `
  <input list="jaminanList" value="${patient.jaminan || ''}" style="width:100%">
`;


  // Tindakan
  cells[20].innerHTML = `<input type="text" value="${patient.tindakan || ''}" style="width:100%">`;

  // Perawat
cells[21].innerHTML = `
  <input list="perawatList" value="${patient.perawat || ''}" style="width:100%">
`;

  // Dokter Jaga
cells[22].innerHTML = `
  <input list="dokterJagaList" value="${patient.dokterJaga || ''}" style="width:100%">
`;


  // Aksi: tombol Simpan & Batal
  const actionCell = cells[cells.length - 1];
  actionCell.innerHTML = '';

  const saveBtn = document.createElement('button');
  saveBtn.textContent = 'Simpan';
  saveBtn.className = 'btn btn-success btn-sm';
  saveBtn.onclick = () => {
  patient.mrn = cells[3].querySelector('input').value;
  patient.nama = cells[4].querySelector('input').value;
  patient.pasien = cells[5].querySelector('select').value;  // Jenis Pasien
  patient.jk = cells[6].querySelector('select').value;      // JK
  patient.tglLahir = cells[7].querySelector('input').value; // Tgl Lahir
  if (patient.tglLahir) {
    patient.usia = calculateAge(patient.tglLahir);
  }
  patient.triase = cells[11].querySelector('input').value;
  patient.diagnosa = cells[12].querySelector('input').value;
  patient.caraDatang = cells[13].querySelector('input').value;
  patient.asalRujukan = cells[14].querySelector('input').value;
  patient.jaminan = cells[15].querySelector('input').value;
  patient.tindakan = cells[20].querySelector('input').value;
  patient.perawat = cells[21].querySelector('input').value;
  patient.dokterJaga = cells[22].querySelector('input').value;

  // simpan ke patientData (rekap)
  patientData[index] = patient;

  // --- SINKRON ke bedData jika pasien masih menempati bed ---
  const bedName = patient.tempat;
  if (bedName && bedData[bedName]) {
    // update hanya field yang relevan (jangan reset jamDatang/jamSelesai)
    const bd = bedData[bedName];
    bd.mrn = patient.mrn;
    bd.nama = patient.nama;
    bd.jk = patient.jk;
    bd.tglLahir = patient.tglLahir;
    bd.usia = patient.usia;
    bd.triase = patient.triase;
    bd.diagnosa = patient.diagnosa;
    bd.caraDatang = patient.caraDatang;
    bd.asalRujukan = patient.asalRujukan;
    bd.jaminan = patient.jaminan;
    bd.tindakan = patient.tindakan;
    bd.perawat = patient.perawat;
    bd.dokterJaga = patient.dokterJaga;
  }

  // refresh tampilan
  generateBedCards();
  loadRekapTable(patientData);
};


  const cancelBtn = document.createElement('button');
  cancelBtn.textContent = 'Batal';
  cancelBtn.className = 'btn btn-secondary btn-sm';
  cancelBtn.onclick = () => loadRekapTable(patientData);

  actionCell.appendChild(saveBtn);
  actionCell.appendChild(cancelBtn);
}



        // Edit patient data from rekap table
        function editPatientData(index) {
            const patient = patientData[index];
            console.log('Edit patient:', patient);
        }

        // Load patient data dari Google Sheets
function loadPatientData() {
  const script = document.createElement('script');
  // callback=handlePatientData → harus sama dengan nama fungsi yang sudah ada untuk mengolah data
  script.src = GOOGLE_SCRIPT_URL + '?callback=handlePatientData';
  document.body.appendChild(script);
}

function handlePatientData(response) {
  if (response.result === "success") {
    patientData = response.data.map((row) => ({
      rowIndex: row.rowIndex,
      tglMasuk: row['Tgl Masuk'] || "",
      tempat: row['Bed'] || "",
      mrn: row['MRN'] || "",
      nama: row['Nama Pasien'] || "",
      pasien: row['Jenis Pasien (B/L)'] === 'B' ? 'Baru' : 'Lama',
      jk: row['JK'] || "",
      usia: row['Usia'] || "",
      jamDatang: row['Jam Datang'] || "",
      jamSelesai: row['Jam Selesai'] || "",
      los: row['LOS'] || "",
      triase: row['Triase'] || "",
      diagnosa: row['Diagnosa'] || "",
      caraDatang: row['Cara Datang'] || "",
      asalRujukan: row['Asal Rujukan'] || "",
      jaminan: row['Jaminan'] || "",
      statusRawat: row['Status Rawat'] || "",
      ruangRawat: row['Ruang Rawat'] || "",
      kelas: row['Kelas'] || "",
      dpjp: row['DPJP'] || "",
      tindakan: row['Tindakan'] || "",
      perawat: row['Perawat/Bidan'] || "",
      dokterJaga: row['Dokter Jaga'] || ""
    }));

    loadRekapTable(patientData);
    console.log("Data berhasil dimuat via JSONP:", patientData.length);
  } else {
    console.error("Error loading data:", response.message);
    alert("Error loading data: " + response.message);
  }
}


        // Tambahkan fungsi ini untuk testing
function testConnection() {
  const script = document.createElement('script');
  script.src = GOOGLE_SCRIPT_URL + '?callback=handleTestConnection';
  document.head.appendChild(script);
}

function handleTestConnection(response) {
  console.log('Test result:', response);
  if (response.result === 'success') {
    alert('Koneksi berhasil! Ditemukan ' + response.data.length + ' data.');
  } else {
    alert('Koneksi gagal: ' + response.message);
  }
}
// Panggil di console browser
testConnection();


        // Close modal when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        
        // Initialize application when page loads
        window.addEventListener('load', init);

        // Auto-tambah Asal Rujukan baru ke masterData
['asalRujukan', 'editAsalRujukan'].forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener('blur', function () {
      const val = this.value.trim();
      if (val && !masterData.asalRujukan.includes(val)) {
        masterData.asalRujukan.push(val);
        refreshDatalists();   // refresh supaya langsung muncul di dropdown
      }
    });
  }
});
    
async function testConnection() {
  try {
    const response = await fetch(GOOGLE_SCRIPT_URL);
    const data = await response.json();
    console.log('Test result:', data);
    alert('Koneksi berhasil! Cek console untuk detail.');
  } catch (error) {
    console.error('Test gagal:', error);
    alert('Koneksi gagal! Periksa URL Apps Script.');
  }
}

    </script>

    
</body>

</html>



